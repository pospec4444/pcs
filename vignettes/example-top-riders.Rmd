---
title: "Example: Top riders in stage race"
author: "Libor PospÃ­chal"
date: "Latest version: `r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
params:
  EVAL: !r TRUE
vignette: >
  %\VignetteIndexEntry{Example: Top riders in stage race}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}

```

## Prerequisities

Data set for this example was created by `R/examples/example.giro.2020.R` script. Riders starting Giro d'Italia 2020 are covered, including their results in 2019 and 2020 seasons.

```{r, message=F, warning=F}
library(dplyr)
library(here)
library(ggplot2)

load(here('data/examples/rider_records_giro2020.rda'))
load(here('data/examples/rider_profiles_giro2020.rda'))
```

## Top 20 riders starting Giro d'Italia 2020 by age

Pick top 20 riders who collected most UCI points since the start of *previous* edition of the race. Calculate riders' age on start of Giro 2020.

```{r, message=F, warning=F}
uci_points_on_start <- rider_records_giro2020 %>%
  subset(date >= '2019-05-11') %>%
  subset(date < '2020-10-03') %>%
  group_by(rider) %>%
  summarise(pointsuci = sum(pointsuci, na.rm = TRUE))

riders_age_points <- rider_profiles_giro2020 %>%
  mutate(age = as.double(difftime('2020-10-03', dob, units = 'weeks') / 52.25)) %>%
  left_join(., uci_points_on_start, by = "rider") %>%
  arrange(desc(pointsuci)) %>%
  head(n = 20)
```

Plot collected UCI points by riders' age:

```{r, message=F, warning=F}
riders_age_points %>%
  ggplot() + aes(x = age, y = pointsuci, label = rider) +
  ylim(NA, 2200) +
  geom_text(check_overlap = TRUE, size = 3, angle = 90,
            vjust = "top", hjust = "left", nudge_x = 0.1) +
  geom_point(shape = 1) +
  labs(x = "Age",
       y = "UCI points")
```
